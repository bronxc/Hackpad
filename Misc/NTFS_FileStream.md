##NTFS_FileStream

###0x01
#####什么是NTFS文件流？  

NTFS数据流指的是微软Windows NT内核的系列，是NTFS磁盘格式的一个特性。  
在介绍NTFS数据流之前，我们先简单了解一下NTFS文件系统。NTFS是微软Windows NT内核的系列操作系统支持的、一个特别为网络和磁盘配额、文件加密等管理安全特性设计的磁盘格式。NTFS比FAT文件系统更稳定，更安全，功能也更为强大。如果要让FAT文件系统转换为NTFS文件系统，可以在“命令提示符”中输入“convert 分区盘符: /fs:ntfs”，即可将该分区的文件系统转换为NTFS。  

NTFS交换数据流（alternate data streams，简称ADS）是NTFS磁盘格式的一个特性，在NTFS文件系统下，每个文件都可以存在多个数据流，就是说除了主文件流之外还可以有许多非主文件流寄宿在主文件流中。它使用资源派生来维持与文件相关的信息，虽然我们无法看到数据流文件，但是它却是真实存在于我们的系统中的。创建一个数据交换流文件的方法很简单，命令为“宿主文件:准备与宿主文件关联的数据流文件”。

###0x02
#####NTFS数据流的创建   

__创建宿主文件__ 


宿主文件在这里指的就是普通文件，是在Windows中可以正常显示、运行、编辑的任何类型文件。我们先来创建一个txt格式的文本文档，把它作为宿主文件。运行“记事本”，输入“test”，然后将其保存为C:\Users\Administrator\Desktop\1.txt。  

__关联宿主文件__  
  
宿主文件创建完成后，我们再来创建一个数据流文件，将其与宿主文件关联，输入命令 `echo "abc" > 1.txt:2.txt`。这样我们就创建了一个名为2.txt，内容为“abc”的数据流文件，并与宿主文件1.txt进行了关联。  

在Desktop文件下，我们发现只有1.txt文件，没有数据流文件2.txt。在1.txt文件中，文件内容没有改变，文件的大小也没有改变。  

如何找到2.txt？在“命令提示符”中输入命令`notepad 1.txt:2.txt`，在弹出的记事本程序中就会出现数据流文件2.txt的内容。而我们在“命令提示符”中使用type、edit等命令对数据流文件进行编辑时，将会出现错误，这是因为“命令提示符”还不能很好地支持数据流文件。记事本虽然能够打开数据流文件，但并不表示它能完全支持NTFS数据流，这一点我们在“另存为”数据流文件的时候就会发现（另存为只有1.txt，而没有数据流文件2.txt）  

__数据流文件删除与拓展__  
  
在“命令提示符”中输入`echo "test" > :2.txt`，这个文件已经在系统中隐身了，我们只能通过输入命令`notepad :2.txt`得知它的存在，而即使知道它的存在，我们也无法删除，因为命令提示符中“del”命令已经失去了作用。唯一能将之删除的办法，就是删除其上一级目录，如果单独的数据流文件存在于磁盘根目录，那么删除它将是一件很痛苦的事。（经验证，我们可以使用"rm"命令来删除指定的数据流文件。）

###0x03
#####提取NTFS文件流文件

专业检测NTFS数据流文件的工具有Sfind.exe、Streams.exe、lads.exe等，。lads.exe是一个命令下的工具，需要在“命令提示符”中使用。在“命令提示符”中运行lads.exe，程序会自动检测当前目录中的NTFS数据流文件，如果要检测子目录中的数据流文件，可以在lads.exe运行的同时添加一个参数“/s”，这样就可以检测到子目录中的数据流文件了。对指定文件夹进行检测时，可以使用“lads.exe 文件夹路径”命令。  

###0x04
#####NTFS文件流利用  
1. 利用NTFS隐藏文本文件  
新建一个1.txt的文本文件，然后在cmd中执行：  
`echo "Yes">>1.txt:2.txt`  
直接打开1.txt，没有任何内容  
cmd中执行： `notepad 1.txt:2.txt`  
得到 `"Yes"`

2. 利用NTFS隐藏图片  
新建一个1.txt的文本文件，准备一张照片1.jpeg，然后在cmd中执行：  
`type 1.jpeg>>1.txt:2.jpeg`  
直接打开1.txt，没有任何内容  
cmd中执行： `mspaint 1.txt:2.jpeg`  
通过微软的画图软件打开了照片

3. 利用NTFS隐藏可执行文件  
新建一个1.txt的文本文件，准备一个可执行文件，这里用cmd.exe替代哈，在cmd中执行：  
`type cmd.exe>>1.txt:2.exe`  
直接打开1.txt，没有任何内容  
cmd中执行： `start C:\1.txt:2.exe`  
(这里需要注意下，`start C:\1.txt:2.exe`是在xp下的执行方式，且start后面需要绝对路径)  
写入的cmd.exe已经执行了。  

这是在win7下NTFS隐藏的可执行文件的执行方式：  
现已在win7环境下准备了一个NTFSNTFS隐藏的执行文件，名字为1.txt:2.exe（2.exe的原型是cmd.exe）  
直接使用 `start` 来运行会提示 “拒绝访问”  
这里先创建一个符号链接文件 `mklink abc.exe 1.txt:2.exe`  
然后会出现一个abc.exe的快捷方式文件，0kb  
cmd中执行 `abc.exe` 即打开了这个隐藏的可执行文件。  
可以在任务管理器进程看到一个名为 1.txt:2.exe 的进程
  

</br>
</br>
</br>


-------------------------------------------------------------
参考文献：  
百度百科：<http://baike.baidu.com/link?url=v_Ssf8Fs0imLy-whTbLPSY9v1P19b3UEDWvDjCvbdM6drherGxdn-B4g1I55zpWUDy81ja_IodlbdVR3nz8v5_>